# ç³»çµ±æ¶æ§‹åœ–

## æ•´é«”æ¶æ§‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ç”¨æˆ¶ç«¯                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              React å‰ç«¯æ‡‰ç”¨                          â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚   â”‚
â”‚  â”‚  â”‚  é¦–é     â”‚  â”‚ æ”¶è—é    â”‚  â”‚ è¿½è¹¤é    â”‚          â”‚   â”‚
â”‚  â”‚  â”‚ (éš¨æ©Ÿ)   â”‚  â”‚          â”‚  â”‚          â”‚          â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜          â”‚   â”‚
â”‚  â”‚       â”‚             â”‚             â”‚                 â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”            â”‚   â”‚
â”‚  â”‚  â”‚      Audio Player å…ƒä»¶               â”‚            â”‚   â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚            â”‚   â”‚
â”‚  â”‚  â”‚  â”‚ æ’­æ”¾æ§åˆ¶ â”‚  â”‚ é€²åº¦æ¢   â”‚         â”‚            â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚            â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚   â”‚
â”‚  â”‚                                                       â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚   â”‚
â”‚  â”‚  â”‚     ç‹€æ…‹ç®¡ç† (Zustand)              â”‚             â”‚   â”‚
â”‚  â”‚  â”‚  - playerStore (æ’­æ”¾å™¨ç‹€æ…‹)         â”‚             â”‚   â”‚
â”‚  â”‚  â”‚  - userStore (ç”¨æˆ¶ç‹€æ…‹)             â”‚             â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚ HTTPS
                         â”‚ REST API
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å¾Œç«¯ API ä¼ºæœå™¨                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              Express.js æ‡‰ç”¨                         â”‚   â”‚
â”‚  â”‚                                                       â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚            API è·¯ç”±å±¤                         â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  /api/random      /api/bookmarks             â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  /api/podcasts    /api/subscriptions         â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â”‚               â”‚                                      â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚         æ§åˆ¶å™¨å±¤ (Controllers)                â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  - PodcastController                         â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  - RandomController                          â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  - UserController                            â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â”‚               â”‚                                      â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚       æ¥­å‹™é‚è¼¯å±¤ (Services)                   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚ Randomizer  â”‚  â”‚ RSS Parser  â”‚            â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  Service    â”‚  â”‚   Service   â”‚            â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  Podcast    â”‚  â”‚    Cache    â”‚            â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  Service    â”‚  â”‚   Service   â”‚            â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â”‚ Prisma ORM
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  PostgreSQL è³‡æ–™åº«                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Podcasts â”‚  â”‚ Episodes â”‚  â”‚Bookmarks â”‚  â”‚Subscrip- â”‚   â”‚
â”‚  â”‚          â”‚  â”‚          â”‚  â”‚          â”‚  â”‚  tions   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚       â”‚             â”‚                                       â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ (é—œè¯)                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              å¤–éƒ¨ Podcast è³‡æ–™ä¾†æº                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚ Podcast Index APIâ”‚  â”‚  iTunes RSS API  â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## è³‡æ–™æµç¨‹åœ–

### éš¨æ©Ÿæ’­æ”¾æµç¨‹

```
ç”¨æˆ¶
 â”‚
 â”‚ 1. é»æ“Šã€Œéš¨æ©Ÿæ’­æ”¾ã€
 â–¼
React å‰ç«¯
 â”‚
 â”‚ 2. useRandomPodcast.playRandom()
 â–¼
API: GET /api/random
 â”‚
 â”‚ 3. è«‹æ±‚éš¨æ©Ÿå…§å®¹
 â–¼
RandomController
 â”‚
 â”‚ 4. èª¿ç”¨æ¥­å‹™é‚è¼¯
 â–¼
RandomizerService
 â”‚
 â”‚ 5. æŸ¥è©¢è³‡æ–™åº«
 â–¼
Prisma â†’ PostgreSQL
 â”‚
 â”‚ 6. è¿”å› Podcast å’Œ Episode
 â–¼
RandomizerService
 â”‚
 â”‚ 7. è¨ˆç®—éš¨æ©Ÿæ™‚é–“é»
 â”‚    startTime = random(0, duration - 300)
 â–¼
API Response
 â”‚
 â”‚ 8. è¿”å› JSON
 â”‚    {
 â”‚      podcast: {...},
 â”‚      episode: {...},
 â”‚      startTime: 1234
 â”‚    }
 â–¼
React å‰ç«¯
 â”‚
 â”‚ 9. æ›´æ–° playerStore
 â”‚    loadAudio(url, id, startTime)
 â–¼
AudioPlayer å…ƒä»¶
 â”‚
 â”‚ 10. è¼‰å…¥éŸ³è¨Š
 â”‚     audio.src = url
 â”‚     audio.currentTime = startTime
 â”‚     audio.play()
 â–¼
ç”¨æˆ¶è½åˆ°éŸ³è¨Š ğŸµ
```

### æ”¶è—æµç¨‹

```
ç”¨æˆ¶é»æ“Šã€Œæ”¶è—ã€
 â”‚
 â–¼
React: useBookmark.addBookmark()
 â”‚
 â–¼
API: POST /api/bookmarks
     Body: {
       episodeId: "xxx",
       currentTime: 150
     }
 â”‚
 â–¼
BookmarkController
 â”‚
 â–¼
Prisma.bookmark.create()
 â”‚
 â–¼
PostgreSQL: æ’å…¥è¨˜éŒ„
 â”‚
 â–¼
API Response: { id, ... }
 â”‚
 â–¼
React: æ›´æ–° UIï¼ˆæŒ‰éˆ•è®Šè‰²ï¼‰
 â”‚
 â–¼
ç”¨æˆ¶çœ‹åˆ°ã€Œå·²æ”¶è—ã€âœ…
```

## æ ¸å¿ƒæ¼”ç®—æ³•

### éš¨æ©Ÿé¸æ“‡æ¼”ç®—æ³•ï¼ˆé¿å…é‡è¤‡ï¼‰

```typescript
class RandomizerService {
  private recentEpisodeIds: Set<string> = new Set();
  private maxRecentSize = 50;

  async getRandomEpisode(): Promise<RandomResult> {
    // 1. éš¨æ©Ÿé¸æ“‡ Podcast
    const totalPodcasts = await prisma.podcast.count();
    const skip = Math.floor(Math.random() * totalPodcasts);
    const podcast = await prisma.podcast.findMany({
      take: 1,
      skip,
      include: {
        episodes: {
          where: {
            // æ’é™¤æœ€è¿‘æ’­æ”¾çš„
            id: { notIn: Array.from(this.recentEpisodeIds) }
          },
          take: 20
        }
      }
    });

    // 2. éš¨æ©Ÿé¸æ“‡ Episode
    const episode = podcast.episodes[
      Math.floor(Math.random() * podcast.episodes.length)
    ];

    // 3. è¨ˆç®—éš¨æ©Ÿèµ·å§‹æ™‚é–“
    // ä¿è­‰è‡³å°‘æœ‰ 5 åˆ†é˜çš„æ’­æ”¾æ™‚é–“
    const maxStartTime = Math.max(0, episode.duration - 300);
    const startTime = Math.floor(Math.random() * maxStartTime);

    // 4. è¨˜éŒ„åˆ°æœ€è¿‘æ’­æ”¾ï¼ˆé˜²æ­¢çŸ­æœŸé‡è¤‡ï¼‰
    this.recentEpisodeIds.add(episode.id);
    if (this.recentEpisodeIds.size > this.maxRecentSize) {
      // ç§»é™¤æœ€èˆŠçš„è¨˜éŒ„
      const oldest = this.recentEpisodeIds.values().next().value;
      this.recentEpisodeIds.delete(oldest);
    }

    return { podcast, episode, startTime };
  }
}
```

**æ™‚é–“è¤‡é›œåº¦**: O(1) - ä½¿ç”¨éš¨æ©Ÿ skipï¼Œä¸éœ€éæ­·æ‰€æœ‰è³‡æ–™
**ç©ºé–“è¤‡é›œåº¦**: O(n) - æœ€å¤šå„²å­˜ 50 å€‹æœ€è¿‘æ’­æ”¾çš„ ID

### åŠ æ¬Šéš¨æ©Ÿï¼ˆå¯é¸é€²éšåŠŸèƒ½ï¼‰

```typescript
// æ ¹æ“š Podcast çš„ç†±é–€åº¦åŠ æ¬Šé¸æ“‡
async getWeightedRandomEpisode(): Promise<RandomResult> {
  const podcasts = await prisma.podcast.findMany({
    include: {
      _count: {
        select: { subscriptions: true }
      }
    }
  });

  // è¨ˆç®—ç¸½æ¬Šé‡ï¼ˆè¿½è¹¤æ•¸ + 1ï¼Œé¿å… 0ï¼‰
  const totalWeight = podcasts.reduce(
    (sum, p) => sum + p._count.subscriptions + 1,
    0
  );

  // éš¨æ©Ÿæ•¸
  let random = Math.random() * totalWeight;

  // æ‰¾åˆ°å°æ‡‰çš„ Podcast
  for (const podcast of podcasts) {
    random -= podcast._count.subscriptions + 1;
    if (random <= 0) {
      return this.selectEpisodeFromPodcast(podcast);
    }
  }
}
```

## å¿«å–ç­–ç•¥

### RSS Feed å¿«å–

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ¶è«‹æ±‚éš¨æ©Ÿæ’­æ”¾                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
        æª¢æŸ¥å¿«å– (Redis)
              â”‚
        â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”
        â”‚           â”‚
     å¿«å–å­˜åœ¨    å¿«å–ä¸å­˜åœ¨/éæœŸ
        â”‚           â”‚
        â–¼           â–¼
    ç›´æ¥è¿”å›    æŠ“å– RSS Feed
        â”‚           â”‚
        â”‚      â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
        â”‚      â”‚ è§£æå…§å®¹ â”‚
        â”‚      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
        â”‚           â”‚
        â”‚      å¯«å…¥å¿«å–
        â”‚      (TTL: 1å°æ™‚)
        â”‚           â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”˜
                â”‚
                â–¼
           è¿”å›è³‡æ–™
```

### å¿«å–è¨­å®šå»ºè­°

| è³‡æ–™é¡å‹ | TTL | ç­–ç•¥ |
|---------|-----|------|
| Podcast åˆ—è¡¨ | 24h | Lazy Loading |
| Episode è©³æƒ… | 1h | Cache-Aside |
| RSS Feed | 1h | Write-Through |
| ç”¨æˆ¶æ”¶è— | - | Write-Through (å³æ™‚æ›´æ–°) |
| éš¨æ©Ÿçµæœ | - | ä¸å¿«å–ï¼ˆä¿æŒéš¨æ©Ÿæ€§ï¼‰ |

## æ“´å±•æ€§è¨­è¨ˆ

### æ°´å¹³æ“´å±•

```
         Load Balancer
              â”‚
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”
      â”‚       â”‚       â”‚
   Server1 Server2 Server3
      â”‚       â”‚       â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
      Shared Database
          (Primary)
              â”‚
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”
   Replica1       Replica2
    (Read)         (Read)
```

### å¾®æœå‹™æ‹†åˆ†ï¼ˆæœªä¾†ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  API Gateway â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
   â”Œâ”€â”€â”€â”´â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚        â”‚          â”‚          â”‚
   â–¼        â–¼          â–¼          â–¼
Random   Podcast    User      Player
Service  Service   Service   Service
   â”‚        â”‚          â”‚          â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
        Shared Database
```

## æ•ˆèƒ½å„ªåŒ–é»

### 1. è³‡æ–™åº«ç´¢å¼•

```sql
-- Podcast æŸ¥è©¢å„ªåŒ–
CREATE INDEX idx_podcast_external_id ON podcasts(external_id);
CREATE INDEX idx_episode_podcast_id ON episodes(podcast_id);
CREATE INDEX idx_episode_pub_date ON episodes(pub_date DESC);

-- ç”¨æˆ¶æŸ¥è©¢å„ªåŒ–
CREATE INDEX idx_bookmark_user_id ON bookmarks(user_id);
CREATE INDEX idx_subscription_user_id ON subscriptions(user_id);
```

### 2. å‰ç«¯å„ªåŒ–

- **ç¨‹å¼ç¢¼åˆ†å‰²**: ä½¿ç”¨ React.lazy() å‹•æ…‹è¼‰å…¥é é¢
- **åœ–ç‰‡å„ªåŒ–**: ä½¿ç”¨ WebP æ ¼å¼ï¼Œlazy loading
- **éŸ³è¨Šé è¼‰**: æå‰è¼‰å…¥ä¸‹ä¸€å€‹éš¨æ©Ÿå…§å®¹
- **ç‹€æ…‹æŒä¹…åŒ–**: ä½¿ç”¨ localStorage è¨˜éŒ„æ’­æ”¾é€²åº¦

### 3. å¾Œç«¯å„ªåŒ–

- **é€£æ¥æ± **: è¨­å®š Prisma é€£æ¥æ± å¤§å°
- **æŸ¥è©¢å„ªåŒ–**: ä½¿ç”¨ `include` æ¸›å°‘ N+1 æŸ¥è©¢
- **ä¸¦ç™¼æ§åˆ¶**: ä½¿ç”¨ Redis è™•ç†é«˜ä¸¦ç™¼
- **èƒŒæ™¯ä»»å‹™**: å®šæœŸæ›´æ–° RSS feed

## å®‰å…¨è€ƒé‡

### API å®‰å…¨

```typescript
// Rate Limiting
app.use('/api', rateLimit({
  windowMs: 15 * 60 * 1000, // 15 åˆ†é˜
  max: 100 // æœ€å¤š 100 å€‹è«‹æ±‚
}));

// CORS
app.use(cors({
  origin: process.env.FRONTEND_URL,
  credentials: true
}));

// Input Validation
app.use(express.json({ limit: '10kb' }));
app.use(helmet()); // è¨­å®šå®‰å…¨ headers
```

### è³‡æ–™é©—è­‰

```typescript
// ä½¿ç”¨ Zod é©—è­‰è¼¸å…¥
const BookmarkSchema = z.object({
  episodeId: z.string().cuid(),
  currentTime: z.number().min(0).max(86400)
});

app.post('/api/bookmarks', async (req, res) => {
  const result = BookmarkSchema.safeParse(req.body);
  if (!result.success) {
    return res.status(400).json({ error: result.error });
  }
  // è™•ç†è«‹æ±‚...
});
```

## ç›£æ§èˆ‡æ—¥èªŒ

### é—œéµæŒ‡æ¨™

- **API å›æ‡‰æ™‚é–“**: ç›®æ¨™ < 200ms (P95)
- **éš¨æ©Ÿæ’­æ”¾æˆåŠŸç‡**: ç›®æ¨™ > 99.5%
- **éŸ³è¨Šè¼‰å…¥æ™‚é–“**: ç›®æ¨™ < 2s
- **éŒ¯èª¤ç‡**: ç›®æ¨™ < 0.1%

### æ—¥èªŒçµæ§‹

```json
{
  "timestamp": "2024-02-10T15:00:00Z",
  "level": "info",
  "service": "random-service",
  "action": "get_random_episode",
  "userId": "user-123",
  "episodeId": "episode-456",
  "duration": 145,
  "status": "success"
}
```

## ç½é›£æ¢å¾©

### å‚™ä»½ç­–ç•¥

- **è³‡æ–™åº«**: æ¯æ—¥è‡ªå‹•å‚™ä»½ï¼Œä¿ç•™ 30 å¤©
- **ç”¨æˆ¶è³‡æ–™**: å³æ™‚è¤‡è£½åˆ°å‚™æ´è³‡æ–™åº«
- **é…ç½®æª”æ¡ˆ**: ç‰ˆæœ¬æ§åˆ¶æ–¼ Git

### æ¢å¾©è¨ˆç•«

1. **è³‡æ–™åº«æ•…éšœ**: åˆ‡æ›åˆ°å‚™æ´è³‡æ–™åº« (< 5min)
2. **API æœå‹™æ•…éšœ**: Load Balancer è‡ªå‹•åˆ‡æ› (< 1min)
3. **å®Œå…¨ç½é›£**: å¾å‚™ä»½æ¢å¾© (< 4h)

---

**ä¸‹ä¸€æ­¥**: æŸ¥çœ‹ [PROJECT_PLAN.md](./PROJECT_PLAN.md) äº†è§£è©³ç´°å¯¦ä½œç´°ç¯€
